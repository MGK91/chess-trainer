<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Junior Gambit Master</title>
    
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        #board { width: 350px; max-width: 95vw; margin: 10px 0; border: 2px solid #555; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; width: 350px; }
        button { padding: 12px; background: #34495e; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        button:active { background: #2ecc71; }
        .info { background: #2c3e50; padding: 15px; border-radius: 8px; width: 320px; margin-top: 10px; text-align: center; }
        #stockfish-btn { display: none; background: #e67e22; width: 350px; margin-top: 10px; padding: 15px; font-size: 16px; }
        /* Debug log for iPhone */
        #debug { font-size: 10px; color: #777; margin-top: 20px; width: 350px; text-align: left; height: 50px; overflow: scroll; border-top: 1px solid #333; }
    </style>
</head>
<body>

    <h2>‚ôüÔ∏è Gambit Trainer</h2>

    <div class="controls">
        <button onclick="loadLevel('evans_attack')">Evans Attack</button>
        <button onclick="loadLevel('evans_defend')">Evans Defend</button>
        <button onclick="loadLevel('morra_attack')">Morra Attack</button>
        <button onclick="loadLevel('morra_defend')">Morra Defend</button>
    </div>

    <div id="board"></div>

    <div class="info">
        <div id="level-name" style="color:#f1c40f; font-weight:bold;">Loading...</div>
        <div id="coach-msg">Please wait...</div>
    </div>

    <button id="stockfish-btn" onclick="startAI()">üî• Beat the AI!</button>

    <div id="debug">System: Initializing...</div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>

    <script>
        const log = (msg) => $('#debug').prepend(msg + '<br>');
        var board = null;
        var game = new Chess();
        var moveIndex = 0;
        var aiMode = false;
        var currentLevel = 'evans_attack';

        const moveSound = new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_standard/move-self.mp3');

        const data = {
            'evans_attack': { side: 'w', moves: ["e4", "e5", "Nf3", "Nc6", "Bc4", "Bc5", "b4"], hints: ["Pawn e4", "Knight f3", "Bishop c4", "EVANS! b4"] },
            'evans_defend': { side: 'b', moves: ["e4", "e5", "Nf3", "Nc6", "Bc4", "Bc5", "b4", "Bxb4", "c3", "Be7", "d4", "Na5"], hints: ["e5", "Nc6", "Bc5", "Take b4", "Be7", "Attack Bishop: Na5"] },
            'morra_attack': { side: 'w', moves: ["e4", "c5", "d4", "cxd4", "c3"], hints: ["e4", "d4", "Sac c3"] },
            'morra_defend': { side: 'b', moves: ["e4", "c5", "d4", "cxd4", "c3", "dxc3", "Nxc3", "Nc6", "Nf3", "e6", "Bc4", "Qc7", "O-O", "Nf6", "Qe2", "Ng4"], hints: ["c5", "Take d4", "Take c3", "Nc6", "e6", "Qc7", "Nf6", "Ng4!"] }
        };

        function onDrop(source, target) {
            let move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';

            if (!aiMode) {
                let expected = data[currentLevel].moves[moveIndex];
                if (move.san !== expected) {
                    game.undo();
                    log("Bad Move: " + move.san);
                    return 'snapback';
                }
                moveIndex++;
                moveSound.play();
                if (moveIndex < data[currentLevel].moves.length) {
                    setTimeout(makeScriptedMove, 500);
                } else {
                    $('#coach-msg').text("Success! Lesson Over.");
                    $('#stockfish-btn').show();
                }
            } else {
                moveSound.play();
                $('#coach-msg').text("AI is thinking...");
                // Simple AI for now to ensure clicks work
                setTimeout(() => {
                    let moves = game.moves();
                    game.move(moves[Math.floor(Math.random() * moves.length)]);
                    board.position(game.fen());
                    moveSound.play();
                }, 500);
            }
        }

        function makeScriptedMove() {
            game.move(data[currentLevel].moves[moveIndex]);
            board.position(game.fen());
            moveIndex++;
            moveSound.play();
            $('#coach-msg').text("Your turn: " + data[currentLevel].hints[Math.floor(moveIndex/2)]);
        }

        function loadLevel(key) {
            currentLevel = key;
            moveIndex = 0;
            aiMode = false;
            game.reset();
            $('#stockfish-btn').hide();
            $('#level-name').text(data[key].side === 'w' ? "Attacking" : "Defending");
            board.orientation(data[key].side === 'w' ? 'white' : 'black');
            board.position('start');
            if (data[key].side === 'b') setTimeout(makeScriptedMove, 500);
            log("Loaded: " + key);
        }

        function startAI() {
            aiMode = true;
            $('#stockfish-btn').hide();
            $('#coach-msg').text("AI Active! Can you win?");
        }

        // Initialize Board
        try {
            board = Chessboard('board', {
                draggable: true,
                dropOffBoard: 'snapback',
                position: 'start',
                onDrop: onDrop,
                // THIS FIXES IMAGES ON GITHUB
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
            });
            loadLevel('evans_attack');
            log("Board Ready.");
        } catch (e) {
            log("Error: " + e);
        }
    </script>
</body>
</html>
