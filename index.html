<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Junior Gambit Master + AI</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #1a1a1a; color: white; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        h2 { margin-bottom: 5px; color: #f1c40f; text-shadow: 2px 2px 4px #000; }
        #board { width: 360px; max-width: 95vw; margin: 10px 0; border: 4px solid #333; border-radius: 5px; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 360px; max-width: 95vw; margin-bottom: 15px; }
        button { padding: 10px; border: none; border-radius: 5px; background: #34495e; color: white; cursor: pointer; font-weight: bold; }
        button:active { transform: scale(0.95); }
        .info-box { background: #2c3e50; padding: 15px; border-radius: 10px; width: 330px; max-width: 90vw; text-align: center; border-left: 5px solid #f1c40f; }
        #coach-msg { font-size: 16px; min-height: 40px; color: #ecf0f1; margin-top: 5px; }
        .highlight-red { box-shadow: inset 0 0 10px 10px rgba(255, 0, 0, 0.7) !important; }
        #stockfish-btn { display: none; background: #e67e22; width: 360px; max-width: 95vw; margin-top: 10px; padding: 12px; }
    </style>
</head>
<body>

    <h2>‚ôüÔ∏è Gambit Master AI</h2>

    <div class="controls">
        <button onclick="loadLevel('evans_attack')">Evans Attack</button>
        <button onclick="loadLevel('evans_defend')">Evans Defend</button>
        <button onclick="loadLevel('morra_attack')">Morra Attack</button>
        <button onclick="loadLevel('morra_defend')">Morra Defend</button>
    </div>

    <div id="board"></div>

    <div class="info-box">
        <span id="level-name" style="color:#f1c40f; font-weight:bold;">Select Level</span>
        <div id="coach-msg">Train your openings!</div>
    </div>

    <button id="stockfish-btn" onclick="startStockfishMode()">üî• Now, Finish the Game vs AI!</button>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

    <script>
        var board = null;
        var game = new Chess();
        var moveIndex = 0;
        var currentLevel = null;
        var stockfishActive = false;
        
        // Stockfish Worker setup
        var stockfish = new Worker('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.2/stockfish.js');
        
        const moveSound = new Audio('https://images.chesscomfiles.com/chess-themes/sounds/_standard/move-self.mp3');
        const errorSound = new Audio('https://www.myinstants.com/media/sounds/wrong-answer-126515.mp3');

        const trainingData = {
            'evans_attack': { name: "Evans Attack (White)", moves: ["e4", "e5", "Nf3", "Nc6", "Bc4", "Bc5", "b4"], hints: ["Center!", "Knight!", "Bishop!", "Evans! b4!"], side: 'w' },
            'evans_defend': { name: "Evans Defense (Black)", moves: ["e4", "e5", "Nf3", "Nc6", "Bc4", "Bc5", "b4", "Bxb4", "c3", "Be7", "d4", "Na5"], hints: ["Match.", "Defend.", "Bishop.", "Take!", "Safe.", "Na5!"], side: 'b' },
            'morra_attack': { name: "Smith-Morra (White)", moves: ["e4", "c5", "d4", "cxd4", "c3"], hints: ["Pawn!", "Strike!", "Sac c3!"], side: 'w' },
            'morra_defend': { name: "Siberian Trap (Black)", moves: ["e4", "c5", "d4", "cxd4", "c3", "dxc3", "Nxc3", "Nc6", "Nf3", "e6", "Bc4", "Qc7", "O-O", "Nf6", "Qe2", "Ng4"], hints: ["Sicilian", "Take", "Take", "Knight", "Prepare", "Queen", "Castled", "Knight", "Queen h2", "TRAP: Ng4!"], side: 'b' }
        };

        function loadLevel(key) {
            currentLevel = key;
            moveIndex = 0;
            stockfishActive = false;
            game.reset();
            board.position('start');
            board.orientation(trainingData[key].side === 'w' ? 'white' : 'black');
            $('#stockfish-btn').hide();
            $('#level-name').text(trainingData[key].name);
            $('#coach-msg').text(trainingData[key].hints[0]);
            if (trainingData[key].side === 'b') setTimeout(makeScriptedMove, 500);
        }

        function onDrop(source, target) {
            let move = game.move({ from: source, to: target, promotion: 'q' });
            if (move === null) return 'snapback';

            if (!stockfishActive) {
                let expected = trainingData[currentLevel].moves[moveIndex].replace('!', '');
                if (move.san !== expected) {
                    game.undo();
                    errorSound.play();
                    $('.square-' + source).addClass('highlight-red');
                    setTimeout(() => $('.square-' + source).removeClass('highlight-red'), 500);
                    return 'snapback';
                }
                moveIndex++;
                moveSound.play();
                if (moveIndex < trainingData[currentLevel].moves.length) {
                    setTimeout(makeScriptedMove, 500);
                } else {
                    $('#coach-msg').text("Level Complete! Want to try and win the rest?");
                    $('#stockfish-btn').fadeIn();
                }
            } else {
                // Stockfish Mode
                moveSound.play();
                $('#coach-msg').text("Stockfish is thinking...");
                setTimeout(askStockfish, 250);
            }
        }

        function makeScriptedMove() {
            game.move(trainingData[currentLevel].moves[moveIndex]);
            board.position(game.fen());
            moveIndex++;
            moveSound.play();
            let hIdx = Math.floor(moveIndex / 2);
            if (trainingData[currentLevel].hints[hIdx]) $('#coach-msg').text(trainingData[currentLevel].hints[hIdx]);
        }

        function startStockfishMode() {
            stockfishActive = true;
            $('#stockfish-btn').hide();
            $('#coach-msg').text("AI Mode Active. Good luck!");
            stockfish.postMessage('uci');
            stockfish.postMessage('setoption name Skill Level value 5'); // Adjust 0-20
        }

        function askStockfish() {
            stockfish.postMessage('position fen ' + game.fen());
            stockfish.postMessage('go depth 12');
            stockfish.onmessage = function(e) {
                if (e.data.includes('bestmove')) {
                    let bestMove = e.data.split(' ')[1];
                    game.move(bestMove, {sloppy: true});
                    board.position(game.fen());
                    moveSound.play();
                    $('#coach-msg').text("Your turn!");
                }
            };
        }

        board = Chessboard('board', {
            draggable: true, position: 'start', onDrop: onDrop,
            onDragStart: (s, p) => {
                if (game.game_over()) return false;
                if (!stockfishActive) {
                   if ((trainingData[currentLevel].side === 'w' && p.search(/^b/) !== -1) ||
                       (trainingData[currentLevel].side === 'b' && p.search(/^w/) !== -1)) return false;
                }
            },
            onSnapEnd: () => board.position(game.fen())
        });

        loadLevel('evans_attack');
    </script>
</body>
</html>
